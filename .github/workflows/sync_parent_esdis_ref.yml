name: Sync Parent ESDIS Reference

on:
  issues:
    types: [opened, edited]

jobs:
  propagate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      repository-projects: write

    steps:
      - name: Sync PCESA Ref from parent
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const PROJECT_ID = 74;
            const FIELD_ID = 254854360;
            
            const issue = context.payload.issue;

            // 1. Find parentâ€™s project item & PCESA value
            const parentData = await github.graphql(`
              query ($id: ID!) {
                node(id: $id) {
                  ... on Issue {
                    id
                    projectItems(first: 10) {
                      nodes {
                        id
                        project { id }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldTextValue {
                              text
                              field { id }
                            }
                          }
                        }
                      }
                    }
                    subIssues(first: 50) {
                      nodes {
                        id
                        repository { nameWithOwner }
                      }
                    }
                  }
                }
              }
            `, { id: issue.node_id });
            
            const parentItem =
              parentData.node.projectItems.nodes
                .find(i => i.project.id === PROJECT_ID);
            
            if (!parentItem) return;
            
            const parentValue =
              parentItem.fieldValues.nodes
                .find(v => v.field.id === FIELD_ID)?.text;
            
            if (!parentValue) return;
            
            // 2. Propagate to children
            for (const child of parentData.node.subIssues.nodes) {
              const childData = await github.graphql(`
                query ($id: ID!) {
                  node(id: $id) {
                    ... on Issue {
                      projectItems(first: 10) {
                        nodes {
                          id
                          project { id }
                          fieldValues(first: 20) {
                            nodes {
                              ... on ProjectV2ItemFieldTextValue {
                                text
                                field { id }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `, { id: child.id });
            
              const childItem =
                childData.node.projectItems.nodes
                  .find(i => i.project.id === PROJECT_ID);
            
              if (!childItem) continue;
            
              const childValue =
                childItem.fieldValues.nodes
                  .find(v => v.field.id === FIELD_ID)?.text;
            
              if (childValue) continue;
            
              await github.graphql(`
                mutation ($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: { text: $value }
                    }
                  ) {
                    projectV2Item { id }
                  }
                }
              `, {
                projectId: PROJECT_ID,
                itemId: childItem.id,
                fieldId: FIELD_ID,
                value: parentValue
              });
            }
            
            
