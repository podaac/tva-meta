name: Sync Parent ESDIS Reference

on:
  project_v2_item:
    types: [created, edited]

jobs:
  propagate:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      projects: write

    steps:
      - name: Sync PCESA Ref from parent
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const PROJECT_ID = 74;
            const FIELD_ID = 254854360;
            const itemId = context.payload.projects_v2_item?.id;
            if (!itemId) return;

            // 1. Fetch item + parent
            const item = await github.graphql(`
              query ($itemId: ID!) {
                node(id: $itemId) {
                  ... on ProjectV2Item {
                    content {
                      ... on Issue {
                        id
                        parent { ... on Issue { id } }
                      }
                    }
                    fieldValues(first: 20) {
                      nodes {
                        ... on ProjectV2ItemFieldTextValue {
                          text
                          field { id name }
                        }
                      }
                    }
                  }
                }
              }
            `, { itemId });

            const issue = item.node.content;
            if (!issue?.parent?.id) return;

            const childValue =
              item.node.fieldValues.nodes
                .find(v => v.field.id === FIELD_ID)?.text;

            if (childValue) return;

            // 2. Fetch parent PCESA value
            const parent = await github.graphql(`
              query ($issueId: ID!) {
                node(id: $issueId) {
                  ... on Issue {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project { id }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldTextValue {
                              text
                              field { id }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `, { issueId: issue.parent.id });

            const parentItem =
              parent.node.projectItems.nodes
                .find(i => i.project.id === PROJECT_ID);

            if (!parentItem) return;

            const parentValue =
              parentItem.fieldValues.nodes
                .find(v => v.field.id === FIELD_ID)?.text;

            if (!parentValue) return;

            // 3. Update child
            await github.graphql(`
              mutation ($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { text: $value }
                  }
                ) {
                  projectV2Item { id }
                }
              }
            `, {
              projectId: PROJECT_ID,
              itemId,
              fieldId: FIELD_ID,
              value: parentValue
            });




