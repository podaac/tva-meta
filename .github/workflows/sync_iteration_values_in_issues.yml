name: Sync Iteration to TVA

on:
  workflow_dispatch:

jobs:
  sync-iteration:
    runs-on: ubuntu-latest
    environment: podaac projects
    permissions:
      issues: read
      contents: read

    steps:
      - name: Sync iteration to TVA
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECTS_TOKEN }}
          script: |
            const ORG = "podaac";
            const TVA_PROJECT_NAME = "tva";
            const ALLOWED_SOURCE_PROJECTS = [
              "hitide-25.4",
              "SOTO PI 25.4"
            ];
            
            async function getProjectByTitle(title) {
              const query = `
                query ($org: String!) {
                  organization(login: $org) {
                    projectsV2(first: 50) {
                      nodes {
                        id
                        title
                        number
                      }
                    }
                  }
                }
              `;
              const res = await github.graphql(query, { org: ORG });
              return res.organization.projectsV2.nodes.find(p => p.title === title);
            }
            
            async function getItems(projectId) {
              const query = `
                query ($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 100) {               # adjust pagination if needed
                        nodes {
                          id
                          content {
                            ... on Issue {
                              id
                              title
                              number
                              repository { name }
                            }
                          }
                          fieldValues(first: 20) {
                            nodes {
                              # iteration
                              ... on ProjectV2ItemFieldIterationValue {
                                title
                                field {
                                  ... on ProjectV2IterationField {
                                    name
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              const res = await github.graphql(query, { projectId });
              return res.node.items.nodes;
            }
            
            const tvaProject = await getProjectByTitle(TVA_PROJECT_NAME);
            if (!tvaProject) throw new Error("TVA project not found");
            
            // Fetch TVA iteration field and configured iterations
            async function getIterationField(projectId) {
              const query = `
                query ($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      fields(first: 50) {
                        nodes {
                          ... on ProjectV2IterationField {
                            id
                            name
                            configuration {
                              iterations {
                                id
                                title
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              const res = await github.graphql(query, { projectId });
              return res.node.fields.nodes.find(f => f.name === "Iteration");
            }
                        
            const tvaIterationField = await getIterationField(tvaProject.id);
            if (!tvaIterationField) throw new Error("TVA iteration field missing");
            
            for (const sourceName of ALLOWED_SOURCE_PROJECTS) {
              console.log(`Processing source project: ${sourceName}`);
              const sourceProject = await getProjectByTitle(sourceName);
              if (!sourceProject) continue;

              const items = await getItems(sourceProject.id);
              // Fetch all items from TVA project once per source project
              const tvaItems = await getItems(tvaProject.id);

              for (const item of items) {
                console.log(`Processing item: ${item.content.id} ${item.content.title}`);
                if (!item.content) continue;

                // Get the source iteration title
                const sourceIteration = item.fieldValues.nodes.find(
                  v => v.field?.name === "Sprint"
                )?.title;

                if (!sourceIteration) continue; 
                console.log(`Fetching source iteration for item ${sourceIteration}`);

                const targetIteration = tvaIterationField.configuration.iterations.find(
                  i => i.title === sourceIteration
                );

                if (!targetIteration) {
                  console.log(`Skipping issue #${item.content.number}, iteration "${sourceIteration}" not found in TVA`);
                  continue;
                }

                // Find the corresponding item in TVA project by content.id
                const tvaItem = tvaItems.find(tvaIt => tvaIt.content && tvaIt.content.id === item.content.id);
                if (!tvaItem) {
                  console.log(`Issue ${item.content.id} not found in TVA project`);
                  continue;
                }
                const tvaItemId = tvaItem.id;

                // 2️⃣ Set iteration field in TVA
                // we assume the issue is already added to the TVA project
                const updateMutation = `
                  mutation ($projectId: ID!, $itemId: ID!, $fieldId: ID!, $iterationId: String!) {
                    updateProjectV2ItemFieldValue(
                      input: {
                        projectId: $projectId
                        itemId: $itemId
                        fieldId: $fieldId
                        value: { iterationId: $iterationId }
                      }
                    ) {
                      projectV2Item { id }
                    }
                  }
                `;

                await github.graphql(updateMutation, {
                  projectId: tvaProject.id,
                  itemId: tvaItemId,
                  fieldId: tvaIterationField.id,
                  iterationId: targetIteration.id
                });

                console.log(`Found target iteration "${targetIteration.title}" with ID ${targetIteration.id}`);
              }

            }

            console.log("Iteration synced to TVA");